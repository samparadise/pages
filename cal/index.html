<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Calendar - Samparadise</title>
	<link rel="icon" type="image/png" href="../img/sam-ico.png">
	<link rel="stylesheet" href="../styles.css">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

	<!-- Bootstrap CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

	<link href="https://fonts.googleapis.com/css2?family=Cutive+Mono&family=Homemade+Apple&family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap" rel="stylesheet">

	<style>
		.calendar-container {
			margin-top: 70px;
			padding: 20px;
			min-height: calc(100vh - 70px);
			background-color: #121212;
		}

		.calendar-wrapper {
			max-width: 1400px;
			margin: 0 auto;
			background: #1a1a1a;
			border-radius: 8px;
			padding: 20px;
			box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
		}

		.view-controls {
			display: flex;
			gap: 10px;
			margin-bottom: 15px;
			flex-wrap: wrap;
			justify-content: center;
			align-items: center;
		}

		.view-btn {
			padding: 8px 16px;
			background: rgba(149, 225, 211, 0.15);
			color: #95e1d3;
			border: 1px solid rgba(149, 225, 211, 0.3);
			border-radius: 4px;
			cursor: pointer;
			font-size: 0.9rem;
			transition: all 0.3s ease;
		}

		.view-btn:hover {
			background: rgba(149, 225, 211, 0.25);
			border-color: rgba(149, 225, 211, 0.5);
		}

		.view-btn.active {
			background: rgba(149, 225, 211, 0.3);
			border-color: #95e1d3;
			color: #fff;
		}

		.date-input {
			padding: 8px 12px;
			background: rgba(255, 255, 255, 0.1);
			color: #e0e0e0;
			border: 1px solid rgba(149, 225, 211, 0.3);
			border-radius: 4px;
			font-size: 0.9rem;
			width: 150px;
		}

		.date-input:focus {
			outline: none;
			border-color: #95e1d3;
			background: rgba(255, 255, 255, 0.15);
		}

		.copy-link-btn {
			padding: 8px 16px;
			background: rgba(149, 225, 211, 0.15);
			color: #95e1d3;
			border: 1px solid rgba(149, 225, 211, 0.3);
			border-radius: 4px;
			cursor: pointer;
			font-size: 0.9rem;
			transition: all 0.3s ease;
		}

		.copy-link-btn:hover {
			background: rgba(149, 225, 211, 0.25);
		}

		.copy-link-btn.copied {
			background: rgba(149, 225, 211, 0.4);
			color: #fff;
		}

		.calendar-iframe {
			width: 100%;
			height: 600px;
			border: none;
			border-radius: 4px;
			background: #fff;
		}

		@media (max-width: 768px) {
			.calendar-container {
				padding: 10px;
				margin-top: 60px;
			}

			.calendar-wrapper {
				padding: 10px;
			}

			.calendar-iframe {
				height: 500px;
			}
		}

		@media (max-width: 600px) {
			.calendar-iframe {
				height: 400px;
			}
		}
	</style>
</head>
<body>
	<!-- Bootstrap Navbar -->
	<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
		<div class="container">
			<a class="navbar-brand" href="../">Samparadise</a>

			<!-- Hamburger Toggle -->
			<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
				aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			</button>

			<!-- Navbar Links -->
			<div class="collapse navbar-collapse" id="navbarNav">
				<ul class="navbar-nav ms-auto">
					<li class="nav-item">
						<a class="nav-link" href="../">Home</a>
					</li>
				</ul>
			</div>
		</div>
	</nav>

	<div class="calendar-container">
		<div class="calendar-wrapper">
			<div class="view-controls">
				<button class="view-btn" data-mode="MONTH">Month</button>
				<button class="view-btn" data-mode="WEEK">Week</button>
				<button class="view-btn" data-mode="AGENDA">Agenda</button>
				<input type="date" id="date-picker" class="date-input" title="Jump to specific date">
				<button class="copy-link-btn" id="copy-link-btn" title="Copy current page URL">Copy Link</button>
			</div>
			<iframe
				id="calendar-iframe"
				class="calendar-iframe"
				frameborder="0"
				scrolling="no">
			</iframe>
		</div>
	</div>

	<!-- Bootstrap JS -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

	<script>
		(function() {
			const calendarId = 'family02716801312634286908@group.calendar.google.com';
			const timezone = 'America/Chicago';
			const iframe = document.getElementById('calendar-iframe');

			// Parse URL parameters
			function getUrlParams() {
				const params = new URLSearchParams(window.location.search);
				const hash = window.location.hash.substring(1);
				const hashParams = hash ? new URLSearchParams(hash) : new URLSearchParams();

				return {
					mode: params.get('mode') || hashParams.get('mode') || 'MONTH',
					dates: params.get('dates') || hashParams.get('dates') || null,
					date: params.get('date') || hashParams.get('date') || null
				};
			}

			// Format date as YYYYMMDD
			function formatDate(date) {
				const year = date.getFullYear();
				const month = String(date.getMonth() + 1).padStart(2, '0');
				const day = String(date.getDate()).padStart(2, '0');
				return `${year}${month}${day}`;
			}

			// Parse date from YYYYMMDD or YYYY-MM-DD
			function parseDate(dateStr) {
				if (!dateStr) return null;
				// Handle YYYYMMDD format
				if (dateStr.length === 8 && /^\d+$/.test(dateStr)) {
					const year = parseInt(dateStr.substring(0, 4));
					const month = parseInt(dateStr.substring(4, 6)) - 1;
					const day = parseInt(dateStr.substring(6, 8));
					return new Date(year, month, day);
				}
				// Handle YYYY-MM-DD format
				return new Date(dateStr);
			}

			// Build calendar URL
			function buildCalendarUrl(params) {
				let url = `https://calendar.google.com/calendar/embed?src=${encodeURIComponent(calendarId)}&ctz=${encodeURIComponent(timezone)}`;

				if (params.mode) {
					url += `&mode=${params.mode}`;
				}

				if (params.dates) {
					url += `&dates=${params.dates}`;
				} else if (params.date) {
					const date = parseDate(params.date);
					if (!date || isNaN(date.getTime())) {
						// Invalid date, skip
					} else if (params.mode === 'WEEK') {
						// Convert single date to week range (Sunday to Saturday)
						const start = new Date(date);
						const dayOfWeek = start.getDay();
						start.setDate(start.getDate() - dayOfWeek); // Start of week (Sunday)
						const end = new Date(start);
						end.setDate(start.getDate() + 6); // End of week (Saturday)
						url += `&dates=${formatDate(start)}/${formatDate(end)}`;
					} else if (params.mode === 'DAY') {
						// Day view needs same date for start and end
						url += `&dates=${formatDate(date)}/${formatDate(date)}`;
					} else if (params.mode === 'MONTH') {
						// Month view - use first and last day of month
						const start = new Date(date.getFullYear(), date.getMonth(), 1);
						const end = new Date(date.getFullYear(), date.getMonth() + 1, 0);
						url += `&dates=${formatDate(start)}/${formatDate(end)}`;
					}
				}

				return url;
			}

			// Update URL without page reload
			function updateUrl(params) {
				const urlParams = new URLSearchParams();
				if (params.mode && params.mode !== 'MONTH') {
					urlParams.set('mode', params.mode);
				}
				if (params.dates) {
					urlParams.set('dates', params.dates);
				} else if (params.date) {
					urlParams.set('date', params.date);
				}

				const newUrl = urlParams.toString()
					? `${window.location.pathname}?${urlParams.toString()}`
					: window.location.pathname;

				window.history.pushState({}, '', newUrl);
			}

			// Initialize calendar
			function initCalendar() {
				const params = getUrlParams();
				const url = buildCalendarUrl(params);
				iframe.src = url;
				updateActiveButton(params.mode);
			}

			// Update active button
			function updateActiveButton(mode) {
				document.querySelectorAll('.view-btn').forEach(btn => {
					if (btn.dataset.mode === mode) {
						btn.classList.add('active');
					} else {
						btn.classList.remove('active');
					}
				});
			}

			// Handle view button clicks
			document.querySelectorAll('.view-btn').forEach(btn => {
				btn.addEventListener('click', function() {
					const mode = this.dataset.mode;
					const params = getUrlParams();
					params.mode = mode;

					// Keep existing date if set, otherwise clear
					if (!params.date && !params.dates) {
						params.date = null;
						params.dates = null;
					}

					updateUrl(params);
					initCalendar();
				});
			});

			// Handle date picker
			const datePicker = document.getElementById('date-picker');
			datePicker.addEventListener('change', function() {
				if (this.value) {
					const params = getUrlParams();
					// Convert YYYY-MM-DD to YYYYMMDD format
					params.date = this.value.replace(/-/g, '');
					params.dates = null; // Clear dates if set
					updateUrl(params);
					initCalendar();
				}
			});

			// Set date picker value from URL on load, or default to today
			const params = getUrlParams();
			if (params.date) {
				const date = parseDate(params.date);
				if (date && !isNaN(date.getTime())) {
					// Convert YYYYMMDD to YYYY-MM-DD for date input
					const dateStr = params.date;
					if (dateStr.length === 8) {
						datePicker.value = `${dateStr.substring(0, 4)}-${dateStr.substring(4, 6)}-${dateStr.substring(6, 8)}`;
					}
				}
			} else {
				// Set to today's date if no date in URL
				const today = new Date();
				const year = today.getFullYear();
				const month = String(today.getMonth() + 1).padStart(2, '0');
				const day = String(today.getDate()).padStart(2, '0');
				datePicker.value = `${year}-${month}-${day}`;
			}

			// Copy link button
			const copyLinkBtn = document.getElementById('copy-link-btn');
			copyLinkBtn.addEventListener('click', function() {
				const url = window.location.href;
				navigator.clipboard.writeText(url).then(() => {
					this.textContent = 'Copied!';
					this.classList.add('copied');
					setTimeout(() => {
						this.textContent = 'Copy Link';
						this.classList.remove('copied');
					}, 2000);
				}).catch(() => {
					// Fallback for older browsers
					const textarea = document.createElement('textarea');
					textarea.value = url;
					document.body.appendChild(textarea);
					textarea.select();
					document.execCommand('copy');
					document.body.removeChild(textarea);
					this.textContent = 'Copied!';
					this.classList.add('copied');
					setTimeout(() => {
						this.textContent = 'Copy Link';
						this.classList.remove('copied');
					}, 2000);
				});
			});

			// Handle browser back/forward
			window.addEventListener('popstate', function() {
				initCalendar();
				// Update date picker
				const params = getUrlParams();
				if (params.date) {
					const dateStr = params.date;
					if (dateStr.length === 8) {
						datePicker.value = `${dateStr.substring(0, 4)}-${dateStr.substring(4, 6)}-${dateStr.substring(6, 8)}`;
					}
				} else {
					datePicker.value = '';
				}
			});

			// Initialize on page load
			initCalendar();
		})();
	</script>
</body>
</html>

